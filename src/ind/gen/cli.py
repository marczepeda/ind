# src/ind/gen/cli.py
from __future__ import annotations
import argparse
import datetime

from . import plot as p
from . import stat as st
from . import io

# --- local helpers ---
def parse_tuple_int(arg: str):
    try:
        return tuple(map(int, arg.split(',')))
    except Exception:
        raise argparse.ArgumentTypeError(f"{arg} must be formatted as 'int,int,...'")

def parse_tuple_float(arg: str):
    try:
        return tuple(map(float, arg.split(',')))
    except Exception:
        raise argparse.ArgumentTypeError(f"{arg} must be formatted as 'float,float,...'")

# ---- plot subparser helpers ----
def add_common_plot_scat_args(sp):
    sp.add_argument("--df", type=str, required=True, help="Input dataframe file path")
    sp.add_argument("--x", type=str, required=True, help="X-axis column")
    sp.add_argument("--y", type=str, required=True, help="Y-axis column")
    sp.add_argument("--cols", type=str, help="Color column name")
    sp.add_argument("--cols_ord", nargs="+", help="Column order (list of values)")
    sp.add_argument("--cols_exclude", nargs="+", help="Columns to exclude from coloring")
    sp.add_argument("--stys", type=str, help="Style column name")
    sp.add_argument("--dir", type=str, default="./out", help="Output directory path")
    sp.add_argument("--file", type=str, default=f'{datetime.datetime.now().strftime("%Y%m%d_%H%M%S")}_plot_scat.png', help="Output file name")
    sp.add_argument("--palette_or_cmap", type=str, default="colorblind", help="Seaborn palette or matplotlib colormap")
    sp.add_argument("--edgecol", type=str, default="black", help="Edge color for scatter points")
    sp.add_argument("--figsize", type=parse_tuple_int, default=(10,6), help="Figure size as width,height")
    sp.add_argument("--title", type=str, default="", help="Plot title")
    sp.add_argument("--title_size", type=int, default=18, help="Plot title font size")
    sp.add_argument("--title_weight", type=str, default="bold", help="Plot title font weight")
    sp.add_argument("--title_font", type=str, default="Arial", help="Font family for the title")
    sp.add_argument("--x_axis", type=str, default="", help="X-axis label")
    sp.add_argument("--x_axis_size", type=int, default=12, help="X-axis label font size")
    sp.add_argument("--x_axis_weight", type=str, default="bold", help="X-axis label font weight")
    sp.add_argument("--x_axis_font", type=str, default="Arial", help="X-axis label font family")
    sp.add_argument("--x_axis_scale", type=str, default="linear", help="X-axis scale")
    sp.add_argument("--x_axis_dims", type=parse_tuple_int, default=(0,0), help="X-axis range start,end")
    sp.add_argument("--x_ticks_rot", type=int, default=0, help="Rotation angle of X-axis tick labels")
    sp.add_argument("--x_ticks_font", type=str, default="Arial", help="Font for X-axis ticks")
    sp.add_argument("--x_ticks", nargs="+", help="Specific X ticks")
    sp.add_argument("--y_axis", type=str, default="", help="Y-axis label")
    sp.add_argument("--y_axis_size", type=int, default=12, help="Y-axis label font size")
    sp.add_argument("--y_axis_weight", type=str, default="bold", help="Y-axis label font weight")
    sp.add_argument("--y_axis_font", type=str, default="Arial", help="Font for Y-axis label")
    sp.add_argument("--y_axis_scale", type=str, default="linear", help="Y-axis scale")
    sp.add_argument("--y_axis_dims", type=parse_tuple_int, default=(0,0), help="Y-axis range start,end")
    sp.add_argument("--y_ticks_rot", type=int, default=0, help="Rotation angle of Y-axis tick labels")
    sp.add_argument("--y_ticks_font", type=str, default="Arial", help="Font for Y-axis ticks")
    sp.add_argument("--y_ticks", nargs="+", help="Specific Y ticks")
    sp.add_argument("--legend_title", type=str, default="", help="Legend title")
    sp.add_argument("--legend_title_size", type=int, default=12, help="Legend title font size")
    sp.add_argument("--legend_size", type=int, default=9, help="Legend font size")
    sp.add_argument("--legend_bbox_to_anchor", type=parse_tuple_float, default=(1,1), help="Legend bbox_to_anchor")
    sp.add_argument("--legend_loc", type=str, default="upper left", help="Legend location")
    sp.add_argument("--legend_items", type=parse_tuple_int, default=(0,0), help="Legend layout helper")
    sp.add_argument("--legend_ncol", type=int, default=1, help="Legend columns")
    sp.add_argument("--show", action="store_true", default=False, help="Show the plot")
    sp.add_argument("--space_capitalize", action="store_true", help="Capitalize labels and replace underscores")

def add_common_plot_cat_args(sp):
    sp.add_argument("--df", type=str, required=True, help="Input dataframe file path")
    sp.add_argument("--x", type=str, default="", help="X-axis column name")
    sp.add_argument("--y", type=str, default="", help="Y-axis column name")
    sp.add_argument("--cols", type=str, help="Color column for grouping")
    sp.add_argument("--cols_ord", nargs="+", help="Color column values order")
    sp.add_argument("--cols_exclude", nargs="+", help="Color values to exclude")
    sp.add_argument("--file", type=str, default="./out", help="Output filename")
    sp.add_argument("--dir", type=str, default=f'{datetime.datetime.now().strftime("%Y%m%d_%H%M%S")}_plot_cat.png', help="Output directory")
    sp.add_argument("--palette_or_cmap", type=str, default="colorblind", help="Palette or colormap")
    sp.add_argument("--edgecol", type=str, default="black", help="Edge color")
    sp.add_argument("--lw", type=int, default=1, help="Edge line width")
    sp.add_argument("--errorbar", type=str, default="sd", help="Error bar type")
    sp.add_argument("--errwid", type=float, default=1, help="Error bar width")
    sp.add_argument("--errcap", type=float, default=0.1, help="Error bar cap")
    sp.add_argument("--figsize", type=parse_tuple_int, default=(10,6), help="Figure size")
    sp.add_argument("--title", type=str, default="", help="Title")
    sp.add_argument("--title_size", type=int, default=18, help="Title size")
    sp.add_argument("--title_weight", type=str, default="bold", help="Title weight")
    sp.add_argument("--title_font", type=str, default="Arial", help="Title font")
    sp.add_argument("--x_axis", type=str, default="", help="X-axis label")
    sp.add_argument("--x_axis_size", type=int, default=12, help="X-axis size")
    sp.add_argument("--x_axis_weight", type=str, default="bold", help="X-axis weight")
    sp.add_argument("--x_axis_font", type=str, default="Arial", help="X-axis font")
    sp.add_argument("--x_axis_scale", type=str, default="linear", help="X scale")
    sp.add_argument("--x_axis_dims", type=parse_tuple_float, default=(0,0), help="X range start,end")
    sp.add_argument("--x_ticks_rot", type=int, default=0, help="X tick rotation")
    sp.add_argument("--x_ticks_font", type=str, default="Arial", help="X tick font")
    sp.add_argument("--x_ticks", nargs="+", help="X ticks")
    sp.add_argument("--y_axis", type=str, default="", help="Y-axis label")
    sp.add_argument("--y_axis_size", type=int, default=12, help="Y-axis size")
    sp.add_argument("--y_axis_weight", type=str, default="bold", help="Y-axis weight")
    sp.add_argument("--y_axis_font", type=str, default="Arial", help="Y-axis font")
    sp.add_argument("--y_axis_scale", type=str, default="linear", help="Y scale")
    sp.add_argument("--y_axis_dims", type=parse_tuple_float, default=(0,0), help="Y range start,end")
    sp.add_argument("--y_ticks_rot", type=int, default=0, help="Y tick rotation")
    sp.add_argument("--y_ticks_font", type=str, default="Arial", help="Y tick font")
    sp.add_argument("--y_ticks", nargs="+", help="Y ticks")
    sp.add_argument("--legend_title", type=str, default="", help="Legend title")
    sp.add_argument("--legend_title_size", type=int, default=12, help="Legend title size")
    sp.add_argument("--legend_size", type=int, default=9, help="Legend size")
    sp.add_argument("--legend_bbox_to_anchor", type=parse_tuple_float, default=(1,1), help="Legend bbox_to_anchor")
    sp.add_argument("--legend_loc", type=str, default="upper left", help="Legend loc")
    sp.add_argument("--legend_items", type=parse_tuple_int, default=(0,0), help="Legend layout helper")
    sp.add_argument("--legend_ncol", type=int, default=1, help="Legend ncol")
    sp.add_argument("--show", action="store_true", default=False, help="Show")
    sp.add_argument("--space_capitalize", action="store_true", help="Capitalize/space labels")

def add_common_plot_dist_args(sp):
    sp.add_argument("--df", type=str, required=True, help="Input dataframe file path")
    sp.add_argument("--x", type=str, required=True, help="X-axis column name")
    sp.add_argument("--dir", type=str, default="./out", help="Output directory")
    sp.add_argument("--file", type=str, default=f'{datetime.datetime.now().strftime("%Y%m%d_%H%M%S")}_plot_dist.png', help="Output file name")
    sp.add_argument("--cols", type=str, help="Color column name for grouping")
    sp.add_argument("--cols_ord", nargs="+", help="Order for color column values")
    sp.add_argument("--cols_exclude", nargs="+", help="Color values to exclude")
    sp.add_argument("--bins", type=int, default=40, help="Histogram bins")
    sp.add_argument("--log10_low", type=int, default=0, help="Log10 lower bound")
    sp.add_argument("--palette_or_cmap", type=str, default="colorblind", help="Palette or cmap")
    sp.add_argument("--edgecol", type=str, default="black", help="Edge color")
    sp.add_argument("--lw", type=int, default=1, help="Line width")
    sp.add_argument("--ht", type=float, default=1.5, help="Height")
    sp.add_argument("--asp", type=int, default=5, help="Aspect ratio")
    sp.add_argument("--tp", type=float, default=0.8, help="Top padding")
    sp.add_argument("--hs", type=int, default=0, help="Horizontal spacing")
    sp.add_argument("--des", action="store_true", default=False, help="Despine")
    sp.add_argument("--figsize", type=parse_tuple_int, default=(10,6), help="Figure size")
    sp.add_argument("--title", type=str, default="", help="Title")
    sp.add_argument("--title_size", type=int, default=18, help="Title size")
    sp.add_argument("--title_weight", type=str, default="bold", help="Title weight")
    sp.add_argument("--title_font", type=str, default="Arial", help="Title font")
    sp.add_argument("--x_axis", type=str, default="", help="X-axis label")
    sp.add_argument("--x_axis_size", type=int, default=12, help="X-axis size")
    sp.add_argument("--x_axis_weight", type=str, default="bold", help="X-axis weight")
    sp.add_argument("--x_axis_font", type=str, default="Arial", help="X-axis font")
    sp.add_argument("--x_axis_scale", type=str, default="linear", help="X scale")
    sp.add_argument("--x_axis_dims", type=parse_tuple_float, default=(0,0), help="X range start,end")
    sp.add_argument("--x_ticks_rot", type=int, default=0, help="X tick rotation")
    sp.add_argument("--x_ticks_font", type=str, default="Arial", help="X tick font")
    sp.add_argument("--x_ticks", nargs="+", help="X ticks")
    sp.add_argument("--y_axis", type=str, default="", help="Y-axis label")
    sp.add_argument("--y_axis_size", type=int, default=12, help="Y-axis size")
    sp.add_argument("--y_axis_weight", type=str, default="bold", help="Y-axis weight")
    sp.add_argument("--y_axis_font", type=str, default="Arial", help="Y-axis font")
    sp.add_argument("--y_axis_scale", type=str, default="linear", help="Y scale")
    sp.add_argument("--y_axis_dims", type=parse_tuple_float, default=(0,0), help="Y range start,end")
    sp.add_argument("--y_ticks_rot", type=int, default=0, help="Y tick rotation")
    sp.add_argument("--y_ticks_font", type=str, default="Arial", help="Y tick font")
    sp.add_argument("--y_ticks", nargs="+", help="Y ticks")
    sp.add_argument("--legend_title", type=str, default="", help="Legend title")
    sp.add_argument("--legend_title_size", type=int, default=12, help="Legend title size")
    sp.add_argument("--legend_size", type=int, default=9, help="Legend size")
    sp.add_argument("--legend_bbox_to_anchor", type=parse_tuple_float, default=(1,1), help="Legend bbox_to_anchor")
    sp.add_argument("--legend_loc", type=str, default="upper left", help="Legend loc")
    sp.add_argument("--legend_items", type=parse_tuple_int, default=(0,0), help="Legend layout helper")
    sp.add_argument("--legend_ncol", type=int, default=1, help="Legend ncol")
    sp.add_argument("--show", action="store_true", default=False, help="Show plot")
    sp.add_argument("--space_capitalize", action="store_true", help="Capitalize/space labels")

def add_common_plot_heat_args(sp):
    sp.add_argument("--df", type=str, required=True, help="Input dataframe file path")
    sp.add_argument("--x", type=str, help="X column to pivot tidy DF")
    sp.add_argument("--y", type=str, help="Y column to pivot tidy DF")
    sp.add_argument("--vars", type=str, help="Variable column to split tidy DF")
    sp.add_argument("--vals", type=str, help="Value column to populate pivots")
    sp.add_argument("--vals_dims", type=parse_tuple_float, help="Value limits vmin,vmax")
    sp.add_argument("--dir", type=str, default="./out", help="Output directory")
    sp.add_argument("--file", type=str, default=f'{datetime.datetime.now().strftime("%Y%m%d_%H%M%S")}_plot_heat.png', help="Output filename")
    sp.add_argument("--edgecol", type=str, default="black", help="Cell edge color")
    sp.add_argument("--lw", type=int, default=1, help="Cell border width")
    sp.add_argument("--annot", action="store_true", default=False, help="Annotate cells")
    sp.add_argument("--cmap", type=str, default="Reds", help="Matplotlib colormap")
    sp.add_argument("--sq", action="store_true", default=False, help="Square cells")
    sp.add_argument("--cbar", action="store_true", default=False, help="Show colorbar")
    sp.add_argument("--title", type=str, default="", help="Title")
    sp.add_argument("--title_size", type=int, default=18, help="Title size")
    sp.add_argument("--title_weight", type=str, default="bold", help="Title weight")
    sp.add_argument("--title_font", type=str, default="Arial", help="Title font")
    sp.add_argument("--figsize", type=parse_tuple_int, default=(10,6), help="Figure size")
    sp.add_argument("--x_axis", type=str, default="", help="X label")
    sp.add_argument("--x_axis_size", type=int, default=12, help="X label size")
    sp.add_argument("--x_axis_weight", type=str, default="bold", help="X label weight")
    sp.add_argument("--x_axis_font", type=str, default="Arial", help="X label font")
    sp.add_argument("--x_ticks_rot", type=int, default=0, help="X ticks rotation")
    sp.add_argument("--x_ticks_font", type=str, default="Arial", help="X ticks font")
    sp.add_argument("--y_axis", type=str, default="", help="Y label")
    sp.add_argument("--y_axis_size", type=int, default=12, help="Y label size")
    sp.add_argument("--y_axis_weight", type=str, default="bold", help="Y label weight")
    sp.add_argument("--y_axis_font", type=str, default="Arial", help="Y label font")
    sp.add_argument("--y_ticks_rot", type=int, default=0, help="Y ticks rotation")
    sp.add_argument("--y_ticks_font", type=str, default="Arial", help="Y ticks font")
    sp.add_argument("--show", action="store_true", default=False, help="Show")
    sp.add_argument("--space_capitalize", action="store_true", help="Capitalize/space labels")

def add_common_plot_stack_args(sp):
    sp.add_argument("--df", type=str, required=True, help="Input dataframe file path")
    sp.add_argument("--x", type=str, help="X column")
    sp.add_argument("--y", type=str, help="Y column")
    sp.add_argument("--cols", type=str, help="Color/stack column")
    sp.add_argument("--dir", type=str, default="./out", help="Output directory")
    sp.add_argument("--file", type=str, default=f'{datetime.datetime.now().strftime("%Y%m%d_%H%M%S")}_plot_stack.png', help="Output filename")
    sp.add_argument("--cutoff_group", type=str, default=argparse.SUPPRESS, help="Group column for cutoff")
    sp.add_argument("--cutoff_value", type=float, default=0, help="Keep values greater than this")
    sp.add_argument("--cutoff_remove", dest="cutoff_keep", action="store_false", default=True, help="Remove values below cutoff")
    sp.add_argument("--cols_ord", nargs="+", help="Order of color values")
    sp.add_argument("--x_ord", nargs="+", help="Custom order of X categories")
    sp.add_argument("--palette_or_cmap", type=str, default="Set2", help="Palette or cmap")
    sp.add_argument("--errcap", type=int, default=4, help="Error bar caps")
    sp.add_argument("--vertical", action="store_true", default=False, help="Vertical layout")
    sp.add_argument("--figsize", type=parse_tuple_int, default=(10,6), help="Figure size")
    sp.add_argument("--title", type=str, default="", help="Title")
    sp.add_argument("--title_size", type=int, default=18, help="Title size")
    sp.add_argument("--title_weight", type=str, default="bold", help="Title weight")
    sp.add_argument("--title_font", type=str, default="Arial", help="Title font")
    sp.add_argument("--x_axis", type=str, default="", help="X label")
    sp.add_argument("--x_axis_size", type=int, default=12, help="X label size")
    sp.add_argument("--x_axis_weight", type=str, default="bold", help="X label weight")
    sp.add_argument("--x_axis_font", type=str, default="Arial", help="X label font")
    sp.add_argument("--x_ticks_rot", type=int, help="X tick rotation")
    sp.add_argument("--x_ticks_font", type=str, default="Arial", help="X tick font")
    sp.add_argument("--y_axis", type=str, default="", help="Y label")
    sp.add_argument("--y_axis_size", type=int, default=12, help="Y label size")
    sp.add_argument("--y_axis_weight", type=str, default="bold", help="Y label weight")
    sp.add_argument("--y_axis_font", type=str, default="Arial", help="Y label font")
    sp.add_argument("--y_axis_dims", type=parse_tuple_float, default=(0,0), help="Y range start,end")
    sp.add_argument("--y_ticks_rot", type=int, help="Y tick rotation")
    sp.add_argument("--y_ticks_font", type=str, default="Arial", help="Y tick font")
    sp.add_argument("--legend_title", type=str, default="", help="Legend title")
    sp.add_argument("--legend_title_size", type=int, default=12, help="Legend title size")
    sp.add_argument("--legend_size", type=int, default=12, help="Legend size")
    sp.add_argument("--legend_bbox_to_anchor", type=parse_tuple_float, default=(1,1), help="Legend bbox_to_anchor")
    sp.add_argument("--legend_loc", type=str, default="upper left", help="Legend location")
    sp.add_argument("--legend_ncol", type=int, default=1, help="Legend columns")
    sp.add_argument("--show", action="store_true", default=False, help="Show")
    sp.add_argument("--space_capitalize", action="store_true", help="Capitalize/space labels")

def add_common_plot_vol_args(sp):
    sp.add_argument("--df", type=str, help="Input dataframe file path")
    sp.add_argument("--x", type=str, help="X-axis column name")
    sp.add_argument("--y", type=str, help="Y-axis column name")
    sp.add_argument("--stys", type=str, help="Style column")
    sp.add_argument("--size", type=str, help="Size column")
    sp.add_argument("--size_dims", type=parse_tuple_float, help="Size range min,max")
    sp.add_argument("--label", type=str, help="Label column")
    sp.add_argument("--FC_threshold", type=float, default=2, help="Fold change threshold")
    sp.add_argument("--pval_threshold", type=float, default=0.05, help="P-value threshold")
    sp.add_argument("--dir", type=str, default="./out", help="Output directory")
    sp.add_argument("--file", type=str, default=f'{datetime.datetime.now().strftime("%Y%m%d_%H%M%S")}_plot_vol.png', help="Output file name")
    sp.add_argument("--color", type=str, default="lightgray", help="Non-significant point color")
    sp.add_argument("--alpha", type=float, default=0.5, help="Non-significant alpha")
    sp.add_argument("--edgecol", type=str, default="black", help="Point edge color")
    sp.add_argument("--vertical", action="store_true", default=False, help="Vertical layout")
    sp.add_argument("--figsize", type=parse_tuple_int, default=(10,6), help="Figure size")
    sp.add_argument("--title", type=str, default="", help="Title")
    sp.add_argument("--title_size", type=int, default=18, help="Title size")
    sp.add_argument("--title_weight", type=str, default="bold", help="Title weight")
    sp.add_argument("--title_font", type=str, default="Arial", help="Title font")
    sp.add_argument("--x_axis", type=str, default="", help="X label")
    sp.add_argument("--x_axis_size", type=int, default=12, help="X label size")
    sp.add_argument("--x_axis_weight", type=str, default="bold", help="X label weight")
    sp.add_argument("--x_axis_font", type=str, default="Arial", help="X label font")
    sp.add_argument("--x_axis_dims", type=parse_tuple_float, default=(0,0), help="X range min,max")
    sp.add_argument("--x_ticks_rot", type=int, default=0, help="X tick rotation")
    sp.add_argument("--x_ticks_font", type=str, default="Arial", help="X tick font")
    sp.add_argument("--x_ticks", nargs="+", help="X ticks")
    sp.add_argument("--y_axis", type=str, default="", help="Y label")
    sp.add_argument("--y_axis_size", type=int, default=12, help="Y label size")
    sp.add_argument("--y_axis_weight", type=str, default="bold", help="Y label weight")
    sp.add_argument("--y_axis_font", type=str, default="Arial", help="Y label font")
    sp.add_argument("--y_axis_dims", type=parse_tuple_float, default=(0,0), help="Y range min,max")
    sp.add_argument("--y_ticks_rot", type=int, default=0, help="Y tick rotation")
    sp.add_argument("--y_ticks_font", type=str, default="Arial", help="Y tick font")
    sp.add_argument("--y_ticks", nargs="+", help="Y ticks")
    sp.add_argument("--legend_title", type=str, default="", help="Legend title")
    sp.add_argument("--legend_title_size", type=int, default=12, help="Legend title size")
    sp.add_argument("--legend_size", type=int, default=9, help="Legend size")
    sp.add_argument("--legend_bbox_to_anchor", type=parse_tuple_float, default=(1,1), help="Legend bbox_to_anchor")
    sp.add_argument("--legend_loc", type=str, default="upper left", help="Legend location")
    sp.add_argument("--legend_items", type=parse_tuple_int, default=(0,0), help="Legend layout helper")
    sp.add_argument("--legend_ncol", type=int, default=1, help="Legend columns")
    sp.add_argument("--display_size", action="store_true", default=False, help="Annotate sizes")
    sp.add_argument("--display_labels", action="store_true", default=False, help="Show text labels")
    sp.add_argument("--return_df", action="store_true", default=False, help="Return annotated DataFrame")
    sp.add_argument("--show", action="store_true", default=False, help="Show")
    sp.add_argument("--space_capitalize", action="store_true", help="Capitalize/space items")

# --- public API used by main.py ---
def add_subparser(subparsers: argparse._SubParsersAction, formatter):
    
    # plot
    parser_plot = subparsers.add_parser(
        "plot",
        help="Generate scatter, category, distribution, heatmap, stacked bar, and volcano plots",
        description="Generate plot types: scat/line/line_scat, bar/box/violin/swarm/strip/point/count, hist/kde/hist_kde/rid, heat, stack, vol",
        formatter_class=formatter,
    )
    sub_plot = parser_plot.add_subparsers(dest="typ")

    # scat/line/line_scat
    for name in ("scat", "line", "line_scat"):
        sp = sub_plot.add_parser(name, help=f"Create {name.replace('_',' + ')} plot", description=f"Create {name.replace('_',' + ')} plot", formatter_class=formatter)
        add_common_plot_scat_args(sp)
        sp.set_defaults(func=p.scat)

    # categorical family
    for name in ("bar","box","violin","swarm","strip","point","count","bar_swarm","box_swarm","violin_swarm"):
        sp = sub_plot.add_parser(name, help=f"Create {name.replace('_',' + ')} plot", description=f"Create {name.replace('_',' + ')} plot", formatter_class=formatter)
        add_common_plot_cat_args(sp)
        sp.set_defaults(func=p.cat)

    # distributions
    for name in ("hist","kde","hist_kde","rid"):
        sp = sub_plot.add_parser(name, help=f"Create {name.replace('_',' + ')} plot", description=f"Create {name.replace('_',' + ')} plot", formatter_class=formatter)
        add_common_plot_dist_args(sp)
        sp.set_defaults(func=p.dist)

    # heatmap
    sp = sub_plot.add_parser("heat", help="Create heatmap plot", description="Create heatmap plot", formatter_class=formatter)
    add_common_plot_heat_args(sp)
    sp.set_defaults(func=p.heat)

    # stacked bar
    sp = sub_plot.add_parser("stack", help="Create stacked bar plot", description="Create stacked bar plot", formatter_class=formatter)
    add_common_plot_stack_args(sp)
    sp.set_defaults(func=p.stack)

    # volcano
    sp = sub_plot.add_parser("vol", help="Create volcano plot", description="Create volcano plot", formatter_class=formatter)
    add_common_plot_vol_args(sp)
    sp.set_defaults(func=p.vol)

    # stat
    parser_stat = subparsers.add_parser("stat", help="Statistics", description="Statistics", formatter_class=formatter)
    sub_stat = parser_stat.add_subparsers()

    sp = sub_stat.add_parser("describe", help="Compute descriptive statistics", description="Compute descriptive statistics", formatter_class=formatter)
    sp.add_argument("--df", type=str, required=True, help="Input file path")
    sp.add_argument("--dir", type=str, default="../out", help="Output directory")
    sp.add_argument("--file", type=str, default=f'{datetime.datetime.now().strftime("%Y%m%d_%H%M%S")}_descriptive.csv', help="Output file name")
    sp.add_argument("--cols", nargs="+", help="Numerical columns to describe")
    sp.add_argument("--group", type=str, help="Column to group by")
    sp.set_defaults(func=st.describe)

    sp = sub_stat.add_parser("difference", help="Compute statistical difference between groups", description="Compute statistical difference between groups", formatter_class=formatter)
    sp.add_argument("--df", type=str, required=True, help="Input file path")
    sp.add_argument("--data_col", type=str, required=True, help="Column with numerical data")
    sp.add_argument("--compare_col", type=str, required=True, help="Grouping column")
    sp.add_argument("--compare", nargs="+", required=True, help="Groups to compare (e.g. A B)")
    sp.add_argument("--dir", type=str, default="../out", help="Output directory")
    sp.add_argument("--file", type=str, default=f'{datetime.datetime.now().strftime("%Y%m%d_%H%M%S")}_difference.csv', help="Output file name")
    sp.add_argument("--same", action="store_true", help="Paired test")
    sp.add_argument("--para", action="store_true", help="Use parametric test")
    sp.add_argument("--alpha", type=float, default=0.05, help="Significance level")
    sp.add_argument("--within_cols", nargs="+", help="Repeated-measures columns")
    sp.add_argument("--method", type=str, default="holm", help="Multiple-comparison correction")
    sp.set_defaults(func=st.difference)

    sp = sub_stat.add_parser("correlation", help="Compute correlation matrix", description="Compute correlation matrix", formatter_class=formatter)
    sp.add_argument("--df", type=str, required=True, help="Input file path")
    sp.add_argument("--dir", type=str, default="../out", help="Output directory")
    sp.add_argument("--file", type=str, default=f'{datetime.datetime.now().strftime("%Y%m%d_%H%M%S")}_correlation.csv', help="Output file name")
    sp.add_argument("--var_cols", nargs="+", help="Two variable columns for tidy format")
    sp.add_argument("--value_cols", nargs="+", help="Numerical columns to correlate")
    sp.add_argument("--method", type=str, default="pearson", choices=["pearson","spearman","kendall"], help="Correlation method")
    sp.add_argument("--numeric_only", action="store_true", help="Only use numeric columns")
    sp.set_defaults(func=st.correlation)

    sp = sub_stat.add_parser("compare", help="Compare conditions using FC, p-values, and log transforms", description="Compare conditions using FC, p-values, and log transforms", formatter_class=formatter)
    sp.add_argument("--df", type=str, required=True, help="Input file path")
    sp.add_argument("--sample", type=str, required=True, help="Sample column")
    sp.add_argument("--cond", type=str, required=True, help="Condition column")
    sp.add_argument("--cond_comp", type=str, required=True, help="Condition to compare against")
    sp.add_argument("--var", type=str, required=True, help="Variable column")
    sp.add_argument("--count", type=str, required=True, help="Count column")
    sp.add_argument("--psuedocount", type=int, default=1, help="Pseudocount")
    sp.add_argument("--dir", type=str, default="../out", help="Output directory")
    sp.add_argument("--file", type=str, default=f'{datetime.datetime.now().strftime("%Y%m%d_%H%M%S")}_compare.csv', help="Output file name")
    sp.set_defaults(func=st.compare)

    # io
    parser_io = subparsers.add_parser("io", help="Input/Output", formatter_class=formatter)
    subparsers_io = parser_io.add_subparsers()

    parser_io_in_subs = subparsers_io.add_parser(
        "in_subs",
        help="*No FASRC* Moves all files with a given suffix into subfolders named after the files (excluding the suffix)",
        description="*No FASRC* Moves all files with a given suffix into subfolders named after the files (excluding the suffix)",
        formatter_class=formatter,
    )
    parser_io_out_subs = subparsers_io.add_parser(
        "out_subs",
        help="*No FASRC* Delete subdirectories and move their files to the parent directory",
        description="*No FASRC* Delete subdirectories and move their files to the parent directory",
        formatter_class=formatter,
    )

    for parser_io_common in [parser_io_in_subs, parser_io_out_subs]:
        parser_io_common.add_argument("--dir", help="Path to parent directory", type=str, required=True)

    parser_io_in_subs.add_argument("--suf", help="File suffix (e.g., '.txt', '.csv') to filter files.", type=str, required=True)

    parser_io_in_subs.set_defaults(func=io.in_subs)
    parser_io_out_subs.set_defaults(func=io.out_subs)